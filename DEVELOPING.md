# Developing in this Python project

This project uses:

- `uv` for project create/init, dependency management, virtual environment management, build, and publish
- `invoke` to run miscellaneous commands
- `ruff` for linting and auto-formatting
- `pre-commit` for automatically running linting/formatting/etc. at pre-commit time
- `bumpver` for automatically bumping version numbers (and tagging, etc.)
- `yamllint` for linting YAML files and enforcing style
- `editorconfig` for setting indent, end-of-line, etc. for many editors/IDEs


[begintoc]: #

## Contents

- [Developer Quickstart](#developer-quickstart)
- [Detailed instructions](#detailed-instructions)
    - [Install `uv`](#install-uv)
    - [Development tools](#development-tools)
    - [Pre-commit hooks](#pre-commit-hooks)
    - [Invoking commands](#invoking-commands)
    - [Lint and format your Python code](#lint-and-format-your-python-code)
    - [Lint YAML files](#lint-yaml-files)
    - [All lint checks](#all-lint-checks)
    - [Maintaining tables of contents in Markdown documents](#maintaining-tables-of-contents-in-markdown-documents)
    - [Running all checks](#running-all-checks)
    - [GitHub workflows](#github-workflows)
    - [Building packages](#building-packages)
    - [Unit tests](#unit-tests)
    - [Version maintenance](#version-maintenance)
- [References](#references)

[endtoc]: # (Generated by mark-toc pre-commit hook)


## Developer Quickstart

1. Install `uv`.
2. Install `pre-commit` and pre-commit hooks.
3. Learn how to lint and format code on the fly.
4. Learn how to bump the version.


## Detailed instructions


### Install `uv`

See [uv's installation instructions][uv-install].

Make sure you can run `uv` when you're done:

    uv --help

> [!TIP]
>
> If this is the first time you've installed `uv`, you may need to start a new shell or terminal
> window, or log out and log back in again, to be able to access it.  If you prefer to be in
> control, you can add the following directory to your `PATH`:
>
> - `~/.local/bin` (or `$HOME/.local/bin`)

- - -

### Development tools

Tools you may need for development are generally listed as `dev` dependencies in the
`[dependency-groups]` section of [pyproject.toml][].

`uv` will automatically add those tools to the Python virtual environment it manages.

- - -

### Pre-commit hooks

Pre-commit hooks are configured in [.pre-commit-config.yaml][pre-commit-config].

If you don't already have it, install `pre-commit` and make sure it works:

    uv run pre-commit-tool use
    pre-commit --help

> [!TIP]
>
> If `pre-commit` isn't available after installing it with `uv`, you may need to add `~/.local/bin`
> (or `$HOME/.local/bin`) to your PATH.  `uv` tries to tell you if that's the case.

Install the configured pre-commit hooks and make sure they're up to date:

    uv run pre-commit-tool install
    uv run pre-commit-tool update

> [!TIP]
>
> `pre-commit` requires files to be added to a git repo in order to check them.

- - -

### Invoking commands

We use [invoke][] to collect, manage, and run commands we need to execute that would otherwise be
memorized or stored in shell scripts.

Invoke refers to these commands as "tasks"; they are stored in [tasks.py][invoke-tasks].

Important tasks (discussed in sections below):

| Task          | Description                                            |
|---------------|--------------------------------------------------------|
| lint          | Run all lint checks (see below)                        |
| checks        | Run all checks -- roughly the same as pre-commit       |
| clean         | Clean up build and runtime detritus                    |
| build         | Build Python source and wheel distributions            |
| tests         | Run tests using `python3 -m unittest discover`         |
| version       | Show or update ("bump") this project's current version |

Lint checks:

| Task              | Description                                       | Has pre-commit hook? |
|-------------------|---------------------------------------------------|----------------------|
| check.json-indent | Run `json-indent` -- parse and format JSON files  | Yes                  |
| check.yamllint    | Run `yamllint` -- check YAML for style and format | Yes                  |
| python.isort      | Run `ruff check` with isort rules -- sort imports | Yes                  |
| python.lint       | Run `ruff check` -- lint Python source files      | Yes                  |
| python.format     | Run `ruff format` -- format Python source files   | Yes                  |

Additional checks:

| Task           | Description                                        | Has pre-commit hook? |
|----------------|----------------------------------------------------|----------------------|
| check.mark-toc | Generate tables of contents for Markdown documents | Yes                  |

To see all available tasks:

    uv run invoke --list

Tasks can support options; for help on a task:

    uv run invoke TASK --help

To run a task in dry-run mode:

    uv run invoke --dry TASK

For more help:

    uv run invoke --help

See [Invoke's documentation][invoke-doc] for further info.

- - -

### Lint and format your Python code

We use [ruff][ruff-doc] to do both linting and auto-formatting of Python source code.
There are pre-commit-hooks to do that, or you can run `invoke` tasks whenever you want:

    uv run invoke python.isort
    uv run invoke python.lint
    uv run invoke python.format

Ruff's linter (`ruff check`) can auto-apply "safe" fixes, if you ask it to:

    uv run invoke python.lint --fix

- - -

### Lint YAML files

We use [yamllint][yamllint-src] to lint YAML files and enforce style.  Rules are configured in
[.yamllint][yamllint-config].

`yamllint` is automatically run on YAML files as part of the pre-commit hooks.  If you want to run
it manually, you can do so with an `invoke` task:

    uv run invoke check.yamllint

This automatically installs the `yamllint` tool using `uv` if it's not already present.

- - -

### All lint checks

To combine all the above linting checks:

    uv run invoke lint

- - -

### Maintaining tables of contents in Markdown documents

There are pre-commit hooks that run `mark-toc` to maintain tables of contents in Markdown documents.
You can do that manually using an `invoke` task:

    uv run invoke check.mark-toc

This automatically installs the `mark-toc` tool using `uv` if it's not already present.

- - -

### Running all checks

To run all checks above, including linting:

    uv run invoke checks

- - -

### GitHub workflows

We use one or more GitHub workflows to check the source, build packages, and publish to PyPI.
Workflows are located in [.github/workflows/][].

> [!NOTE]
>
> The steps for checking source may seem redundant alongside pre-commit hooks, but note that
> pre-commit hooks are on the "honor system" -- you have to install them locally for them to run.
> So we do the same checks in our GitHub workflow, to make sure they've been done ... trust, but
> verify.

- - -

### Building packages

To build source and wheel packages ("distributions"):

    uv run invoke build

To clean up artifacts from building, etc.:

    uv run invoke clean

To do a clean before building:

    uv run invoke clean build

- - -

### Unit tests

To run tests:

    uv run invoke tests

For more info, see [tests/README.md][].

- - -

### Version maintenance

We use [bumpver][bumpver-src] to maintain version numbers.

The `[tool.bumpver]` configuration in [pyproject.toml][] is set up to:

- Use semantic versions, with a leading `v` (`v1.2.3`, for example)
- Commit, tag, and push the version change automatically

Show the current version:

    uv run invoke version

Bump the patch version in dry-run mode (without actually doing it):

    uv run invoke version --bump --patch

Bump the patch version for real:

    uv run invoke version --bump --patch --go

> [!NOTE]
>
> The [.bumpver-pre-commit-hook.sh][] script does the housekeeping necessary to keep the `uv.lock`
> file in sync when the version in `pyproject.toml` changes.

More info:

    uv run invoke version --help
    uv run bumpver --help

> [!IMPORTANT]
>
> **Pre-release versions, post-release versions, etc.**
>
> As a generic version maintenance tool with support for several different version schemes,
> `bumpver` has varying levels of accurate support for [PEP 440][pep-440] pre-release segments,
> post-release segments, and development release segments (hereafter, "release tags"):
>
> - Prior to version 2024.1130, `bumpver` did not sort release tags properly at all.
> - Starting with version 2024.1130, `bumpver`:
>     - **Sorts all** release tags properly (`dev` < `alpha` < `beta` < `rc` < `final` < `post`)
>     - **Formats pre-release** tags correctly (`alpha`, `beta`, and `rc`), but
>     - Does *not* format development (`dev`) and post-release (`post`) tags correctly (they should
>       show up as `.postN` or `.devN`, but `bumpver` leaves out the `.`).
>
> This project requires at least version 2024.1130.  Consequently, if you wish to use release tags,
> it is recommended to stick with pre-release tags only and avoid development or post-release tags.
> Invoking bumpver via `uv run invoke version --bump` enforces this recommendation.
>
> Also, note that, if the current version is a "final" version (with no release tag), bumping to a
> pre-release version requires bumping the major, minor, or patch version as well.  For example:
>
>     # version: v0.1.0
>     uv run invoke version --bump --patch --release-tag rc
>     # result: v0.1.1rc0


## References

- **bumpver**       ( [GitHub][bumpver-src] | [PyPI][bumpver-pypi] | [PEP 440][pep-440] )
- **editorconfig**  ( [Home][editorconfig] | [Config][editorconfig-config] )
- **invoke**        ( [Home][invoke] | [GitHub][invoke-src] | [Documentation][invoke-doc] | [Config][invoke-config] | [Tasks][invoke-tasks] )
- **pre-commit**    ( [Home][pre-commit] | [GitHub][pre-commit-src] | [Config][pre-commit-config] )
- **ruff**          ( [GitHub][ruff-src] | [Documentation][ruff-doc] )
- **uv**            ( [Install][uv-install] | [GitHub][uv-src] | [Documentation][uv-doc] )
- **yamllint**      ( [GitHub][yamllint-src] | [Documentation][yamllint-doc] | [Config][yamllint-config] )


 [.bumpver-pre-commit-hook.sh]: .bumpver-pre-commit-hook.sh
 [.github/workflows/]: .github/workflows/
 [pyproject.toml]: pyproject.toml
 [tests/README.md]: tests/README.md

 [pep-440]: https://peps.python.org/pep-0440/

 [bumpver-src]: https://github.com/mbarkhau/bumpver
 [bumpver-pypi]: https://pypi.org/project/bumpver/

 [editorconfig]: https://editorconfig.org/
 [editorconfig-config]: .editorconfig

 [invoke]: https://www.pyinvoke.org/
 [invoke-src]: https://github.com/pyinvoke/invoke
 [invoke-doc]: https://docs.pyinvoke.org/en/stable/
 [invoke-tasks]: tasks.py
 [invoke-config]: invoke.yaml

 [pre-commit]: https://pre-commit.com/
 [pre-commit-src]: https://github.com/pre-commit/pre-commit
 [pre-commit-config]: .pre-commit-config.yaml

 [ruff-src]: https://github.com/astral-sh/ruff
 [ruff-doc]: https://docs.astral.sh/ruff

 [uv-install]: https://docs.astral.sh/uv/getting-started/installation
 [uv-src]: https://github.com/astral-sh/uv
 [uv-doc]: https://docs.astral.sh/uv

 [yamllint-src]: https://github.com/adrienverge/yamllint
 [yamllint-doc]: https://yamllint.readthedocs.io/en/stable/
 [yamllint-config]: .yamllint
